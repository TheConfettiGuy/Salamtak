"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/chat/route";
exports.ids = ["app/api/chat/route"];
exports.modules = {

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "node:fs":
/*!**************************!*\
  !*** external "node:fs" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("node:fs");

/***/ }),

/***/ "node:path":
/*!****************************!*\
  !*** external "node:path" ***!
  \****************************/
/***/ ((module) => {

module.exports = require("node:path");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2FUsers%2Fmarcobaghdadi%2FDownloads%2FAI%20Chatbot%2FSalamtak%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fmarcobaghdadi%2FDownloads%2FAI%20Chatbot%2FSalamtak&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2FUsers%2Fmarcobaghdadi%2FDownloads%2FAI%20Chatbot%2FSalamtak%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fmarcobaghdadi%2FDownloads%2FAI%20Chatbot%2FSalamtak&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var _Users_marcobaghdadi_Downloads_AI_Chatbot_Salamtak_app_api_chat_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./app/api/chat/route.ts */ \"(rsc)/./app/api/chat/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/chat/route\",\n        pathname: \"/api/chat\",\n        filename: \"route\",\n        bundlePath: \"app/api/chat/route\"\n    },\n    resolvedPagePath: \"/Users/marcobaghdadi/Downloads/AI Chatbot/Salamtak/app/api/chat/route.ts\",\n    nextConfigOutput,\n    userland: _Users_marcobaghdadi_Downloads_AI_Chatbot_Salamtak_app_api_chat_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/chat/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZjaGF0JTJGcm91dGUmcGFnZT0lMkZhcGklMkZjaGF0JTJGcm91dGUmYXBwUGF0aHM9JnBhZ2VQYXRoPXByaXZhdGUtbmV4dC1hcHAtZGlyJTJGYXBpJTJGY2hhdCUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRm1hcmNvYmFnaGRhZGklMkZEb3dubG9hZHMlMkZBSSUyMENoYXRib3QlMkZTYWxhbXRhayUyRmFwcCZwYWdlRXh0ZW5zaW9ucz10c3gmcGFnZUV4dGVuc2lvbnM9dHMmcGFnZUV4dGVuc2lvbnM9anN4JnBhZ2VFeHRlbnNpb25zPWpzJnJvb3REaXI9JTJGVXNlcnMlMkZtYXJjb2JhZ2hkYWRpJTJGRG93bmxvYWRzJTJGQUklMjBDaGF0Ym90JTJGU2FsYW10YWsmaXNEZXY9dHJ1ZSZ0c2NvbmZpZ1BhdGg9dHNjb25maWcuanNvbiZiYXNlUGF0aD0mYXNzZXRQcmVmaXg9Jm5leHRDb25maWdPdXRwdXQ9JnByZWZlcnJlZFJlZ2lvbj0mbWlkZGxld2FyZUNvbmZpZz1lMzAlM0QhIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFzRztBQUN2QztBQUNjO0FBQ3dCO0FBQ3JHO0FBQ0E7QUFDQTtBQUNBLHdCQUF3QixnSEFBbUI7QUFDM0M7QUFDQSxjQUFjLHlFQUFTO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxZQUFZO0FBQ1osQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBLFFBQVEsaUVBQWlFO0FBQ3pFO0FBQ0E7QUFDQSxXQUFXLDRFQUFXO0FBQ3RCO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDdUg7O0FBRXZIIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vbmV4dGpzLW9sbGFtYS1yYWctc21hcnRkb2N0b3IvPzk4M2YiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwUm91dGVSb3V0ZU1vZHVsZSB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1tb2R1bGVzL2FwcC1yb3V0ZS9tb2R1bGUuY29tcGlsZWRcIjtcbmltcG9ydCB7IFJvdXRlS2luZCB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1raW5kXCI7XG5pbXBvcnQgeyBwYXRjaEZldGNoIGFzIF9wYXRjaEZldGNoIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvbGliL3BhdGNoLWZldGNoXCI7XG5pbXBvcnQgKiBhcyB1c2VybGFuZCBmcm9tIFwiL1VzZXJzL21hcmNvYmFnaGRhZGkvRG93bmxvYWRzL0FJIENoYXRib3QvU2FsYW10YWsvYXBwL2FwaS9jaGF0L3JvdXRlLnRzXCI7XG4vLyBXZSBpbmplY3QgdGhlIG5leHRDb25maWdPdXRwdXQgaGVyZSBzbyB0aGF0IHdlIGNhbiB1c2UgdGhlbSBpbiB0aGUgcm91dGVcbi8vIG1vZHVsZS5cbmNvbnN0IG5leHRDb25maWdPdXRwdXQgPSBcIlwiXG5jb25zdCByb3V0ZU1vZHVsZSA9IG5ldyBBcHBSb3V0ZVJvdXRlTW9kdWxlKHtcbiAgICBkZWZpbml0aW9uOiB7XG4gICAgICAgIGtpbmQ6IFJvdXRlS2luZC5BUFBfUk9VVEUsXG4gICAgICAgIHBhZ2U6IFwiL2FwaS9jaGF0L3JvdXRlXCIsXG4gICAgICAgIHBhdGhuYW1lOiBcIi9hcGkvY2hhdFwiLFxuICAgICAgICBmaWxlbmFtZTogXCJyb3V0ZVwiLFxuICAgICAgICBidW5kbGVQYXRoOiBcImFwcC9hcGkvY2hhdC9yb3V0ZVwiXG4gICAgfSxcbiAgICByZXNvbHZlZFBhZ2VQYXRoOiBcIi9Vc2Vycy9tYXJjb2JhZ2hkYWRpL0Rvd25sb2Fkcy9BSSBDaGF0Ym90L1NhbGFtdGFrL2FwcC9hcGkvY2hhdC9yb3V0ZS50c1wiLFxuICAgIG5leHRDb25maWdPdXRwdXQsXG4gICAgdXNlcmxhbmRcbn0pO1xuLy8gUHVsbCBvdXQgdGhlIGV4cG9ydHMgdGhhdCB3ZSBuZWVkIHRvIGV4cG9zZSBmcm9tIHRoZSBtb2R1bGUuIFRoaXMgc2hvdWxkXG4vLyBiZSBlbGltaW5hdGVkIHdoZW4gd2UndmUgbW92ZWQgdGhlIG90aGVyIHJvdXRlcyB0byB0aGUgbmV3IGZvcm1hdC4gVGhlc2Vcbi8vIGFyZSB1c2VkIHRvIGhvb2sgaW50byB0aGUgcm91dGUuXG5jb25zdCB7IHJlcXVlc3RBc3luY1N0b3JhZ2UsIHN0YXRpY0dlbmVyYXRpb25Bc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzIH0gPSByb3V0ZU1vZHVsZTtcbmNvbnN0IG9yaWdpbmFsUGF0aG5hbWUgPSBcIi9hcGkvY2hhdC9yb3V0ZVwiO1xuZnVuY3Rpb24gcGF0Y2hGZXRjaCgpIHtcbiAgICByZXR1cm4gX3BhdGNoRmV0Y2goe1xuICAgICAgICBzZXJ2ZXJIb29rcyxcbiAgICAgICAgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZVxuICAgIH0pO1xufVxuZXhwb3J0IHsgcm91dGVNb2R1bGUsIHJlcXVlc3RBc3luY1N0b3JhZ2UsIHN0YXRpY0dlbmVyYXRpb25Bc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzLCBvcmlnaW5hbFBhdGhuYW1lLCBwYXRjaEZldGNoLCAgfTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9YXBwLXJvdXRlLmpzLm1hcCJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2FUsers%2Fmarcobaghdadi%2FDownloads%2FAI%20Chatbot%2FSalamtak%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fmarcobaghdadi%2FDownloads%2FAI%20Chatbot%2FSalamtak&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./app/api/chat/route.ts":
/*!*******************************!*\
  !*** ./app/api/chat/route.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST),\n/* harmony export */   runtime: () => (/* binding */ runtime)\n/* harmony export */ });\n/* harmony import */ var _utils_retrieval__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @/utils/retrieval */ \"(rsc)/./utils/retrieval.ts\");\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! node:fs */ \"node:fs\");\n/* harmony import */ var node_fs__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(node_fs__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! node:path */ \"node:path\");\n/* harmony import */ var node_path__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(node_path__WEBPACK_IMPORTED_MODULE_3__);\n\n\n\n\nconst runtime = \"nodejs\";\nlet KB_CACHE = null;\nfunction loadKB() {\n    if (KB_CACHE) return KB_CACHE;\n    const p = node_path__WEBPACK_IMPORTED_MODULE_3___default().join(process.cwd(), \"data\", \"intents_merged.json\");\n    const raw = node_fs__WEBPACK_IMPORTED_MODULE_2___default().readFileSync(p, \"utf-8\");\n    KB_CACHE = JSON.parse(raw);\n    return KB_CACHE;\n}\nfunction normalizeInline(s) {\n    return s.toLowerCase().normalize(\"NFKC\").replace(/[^\\p{L}\\p{N}\\s]/gu, \" \").replace(/\\s+/g, \" \").trim();\n}\nfunction jaccardFromStrings(a, b) {\n    const A = new Set(normalizeInline(a).split(\" \").filter(Boolean));\n    const B = new Set(normalizeInline(b).split(\" \").filter(Boolean));\n    const inter = new Set([\n        ...A\n    ].filter((x)=>B.has(x))).size;\n    const uni = new Set([\n        ...A,\n        ...B\n    ]).size || 1;\n    return inter / uni;\n}\nfunction buildDialogueContext(messages, latest) {\n    const MAX_BACK = 8;\n    const SIM_THRESHOLD = 0.2;\n    const prev = messages.slice(0, -1).slice(-MAX_BACK);\n    const related = [];\n    for(let i = prev.length - 1; i >= 0; i--){\n        const m = prev[i];\n        if (m.role === \"user\") {\n            const sim = jaccardFromStrings(m.content, latest);\n            if (sim >= SIM_THRESHOLD) {\n                const ans = i + 1 < prev.length && prev[i + 1].role === \"assistant\" ? prev[i + 1].content : \"\";\n                related.push({\n                    q: m.content,\n                    a: ans\n                });\n            }\n        }\n    }\n    if (!related.length) return \"\";\n    return related.slice(0, 2).map((p)=>`Q: ${p.q}\\nA: ${p.a}`).join(\"\\n\\n\");\n}\nfunction isChitChat(s) {\n    const n = normalizeInline(s);\n    const patterns = [\n        /^hi\\b|^hello\\b|^hey\\b|^salam\\b|^marhaba\\b/,\n        /\\bhow are (you|u)\\b/,\n        /\\bcan i ask (a )?question\\b/,\n        /\\bthank(s| you)\\b/,\n        /\\bbye\\b|\\bgoodbye\\b|\\bsee you\\b/\n    ];\n    return patterns.some((rx)=>rx.test(n));\n}\nfunction chitChatReply(s, lang) {\n    const hi = lang === \"ar\" ? \"مرحبًا! \\uD83D\\uDE0A\" : \"Hi there! \\uD83D\\uDE0A\";\n    const norm = normalizeInline(s);\n    if (/\\bhow are (you|u)\\b/.test(norm)) {\n        return lang === \"ar\" ? \"أنا بخير، شكرًا لسؤالك! كيف يمكنني مساعدتك؟\" : \"I’m doing well, thanks for asking! How can I help today?\";\n    }\n    if (/(^|\\b)(can i|may i) ask( a)? question(\\b|$)/.test(norm)) {\n        return lang === \"ar\" ? \"أكيد! اسألني أي سؤال تريده. \\uD83D\\uDE42\" : \"Of course! Ask me anything. \\uD83D\\uDE42\";\n    }\n    if (/\\bthank(s| you)\\b/.test(norm)) {\n        return lang === \"ar\" ? \"على الرحب والسعة! إذا أردت، اسألني أي شيء. \\uD83D\\uDE4F\" : \"You’re welcome! Feel free to ask me anything. \\uD83D\\uDE4F\";\n    }\n    if (/\\bbye\\b|\\bgoodbye\\b|\\bsee you\\b/.test(norm)) {\n        return lang === \"ar\" ? \"إلى اللقاء! اعتنِ بنفسك. \\uD83D\\uDC4B\" : \"Goodbye! Take care. \\uD83D\\uDC4B\";\n    }\n    return lang === \"ar\" ? `${hi} اسألني ما تشاء—سأجيب بناءً على المعلومات المتاحة.` : `${hi} Ask me anything — I’ll answer based on the info I have.`;\n}\n// sanitize reply: remove bullets/snippet mentions; keep paragraphs\nfunction sanitize(output) {\n    output = output.replace(/^\\s*([*\\-•]\\s*)+/gm, \"\");\n    output = output.replace(/\\b(Snippet\\s*\\d+|from snippet\\s*\\d+|from the snippet|according to the snippet)\\b.*?:?/gi, \"\");\n    output = output.replace(/\\n{3,}/g, \"\\n\\n\").trim();\n    return output;\n}\n// ===== Friendly + strict doctor persona rules (AR/EN) =====\nfunction buildSystemPrompt(userLang) {\n    const langInstruction = userLang === \"ar\" ? \"أجب باللغة العربية ما لم يطلب المستخدم غير ذلك.\" : \"Answer in English unless the user requests Arabic.\";\n    const persona = userLang === \"ar\" ? \"أنت طبيب/ة ودود/ة ومتعاطف/ة مختص/ة بصحة المراهقين. تحدّث ببساطة وطمأنة، وبأسلوب مهني قريب من الناس.\" : \"You are a warm, empathetic medical doctor specializing in adolescent health. Speak clearly, reassuringly, and professionally.\";\n    const rules = [\n        persona,\n        \"You MUST answer only using the provided CONTEXT.\",\n        \"Continuity: If the user is asking a follow-up about the same subject, keep answers consistent with earlier turns. If the subject changed, treat it as a new question.\",\n        \"RULES:\",\n        \"1) Do NOT invent or guess. No information outside the CONTEXT.\",\n        \"2) If asked to summarize, summarize faithfully from the CONTEXT only.\",\n        '3) If the question is related to puberty/relationships/safety but not covered by CONTEXT, reply: \"It’s better to ask a doctor or a trusted adult.\"',\n        '4) If the question is outside the domain entirely, reply exactly: \"I cant answer this question\"',\n        \"5) For specific questions, paraphrase from the CONTEXT. You may quote short lines.\",\n        \"6) Be concise and kind. Use short paragraphs (no lists).\",\n        \"EXTRA RULES:\",\n        \"A) Keep a warm, supportive, doctor-like tone. Use light emojis when appropriate (\\uD83D\\uDE42\\uD83E\\uDD1D), but keep answers short and clear.\",\n        \"B) For “nearest/closest clinic/health center” around Tripoli/Akkar:\",\n        \"   - If the user didn’t specify an area, politely ask for their area/neighborhood first.\",\n        \"   - Otherwise, answer using the JSON health-centers responses (the Akkar links). Encourage opening the Google Maps links.\",\n        \"C) DO NOT use markdown bullets or lists (no *, -, •, 1.). Answer in plain sentences/paragraphs only.\",\n        \"D) DO NOT mention snippets, tags, patterns, context, dataset, or sources. Just answer directly.\",\n        langInstruction\n    ];\n    return rules.join(\"\\n\");\n}\n// ===== Simple area→link hint for Akkar locations (optional preface) =====\nconst AREA_MAP = {\n    tripoli: \"https://maps.app.goo.gl/WQKfbTVWTD6TUwrL8\",\n    mina: \"https://maps.app.goo.gl/WQKfbTVWTD6TUwrL8\",\n    minaa: \"https://maps.app.goo.gl/WQKfbTVWTD6TUwrL8\",\n    qobbeh: \"https://maps.app.goo.gl/WQKfbTVWTD6TUwrL8\",\n    kobbeh: \"https://maps.app.goo.gl/WQKfbTVWTD6TUwrL8\",\n    halba: \"https://maps.app.goo.gl/gi46nv51nsE7tHJY6\",\n    bebnine: \"https://maps.app.goo.gl/ujc7GUmEJouMYwJS9\",\n    bkarzla: \"https://maps.app.goo.gl/m3GerH3EgVm1ShTq6\",\n    akkar: \"https://maps.app.goo.gl/gi46nv51nsE7tHJY6\"\n};\nfunction guessNearestLink(s) {\n    const t = (s || \"\").toLowerCase();\n    for (const k of Object.keys(AREA_MAP)){\n        if (t.includes(k)) return AREA_MAP[k];\n    }\n    return null;\n}\n// ===== Build the correct chat endpoint (avoids double /v1) =====\nfunction buildChatEndpoint(base) {\n    if (!base) return \"/api/v1/chat/completions\";\n    const trimmed = base.replace(/\\/+$/, \"\");\n    // If base already ends with /api/v1, append /chat/completions\n    if (/\\/api\\/v1$/.test(trimmed)) return `${trimmed}/chat/completions`;\n    // If base already ends with /v1, append /chat/completions\n    if (/\\/v1$/.test(trimmed)) return `${trimmed}/chat/completions`;\n    // Otherwise assume origin; append /api/v1/chat/completions\n    return `${trimmed}/api/v1/chat/completions`;\n}\nasync function POST(req) {\n    try {\n        const { messages } = await req.json();\n        if (!messages?.length) return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.json({\n            error: \"Missing messages\"\n        }, {\n            status: 400\n        });\n        const kb = loadKB();\n        const latest = messages[messages.length - 1]?.content || \"\";\n        const userLang = (0,_utils_retrieval__WEBPACK_IMPORTED_MODULE_0__.detectArabic)(latest) ? \"ar\" : \"en\";\n        // Friendly chit-chat (allowed exception)\n        if (isChitChat(latest)) {\n            const reply = chitChatReply(latest, userLang);\n            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.json({\n                reply,\n                meta: {\n                    chitchat: true\n                }\n            });\n        }\n        // Dialogue continuity context\n        const dialogueCtx = buildDialogueContext(messages, latest);\n        const retrievalQuery = dialogueCtx ? `${latest}\n\nFollow-up context (for meaning only):\n${dialogueCtx}` : latest;\n        // Retrieve from your JSON KB\n        const { top, best, globalRelatedness } = (0,_utils_retrieval__WEBPACK_IMPORTED_MODULE_0__.retrieve)(retrievalQuery, kb, 10);\n        // Thresholds\n        const BEST_MIN = 0.18;\n        const RELATED_MIN = 0.1;\n        // Out-of-domain hard stop\n        if (best.score < RELATED_MIN && globalRelatedness < 0.22) {\n            const msg = userLang === \"ar\" ? \"I cant answer this question\" : \"I cant answer this question\";\n            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.json({\n                reply: msg,\n                meta: {\n                    reason: \"out_of_domain\",\n                    score: best.score,\n                    globalRelatedness\n                }\n            });\n        }\n        // In-domain but not covered → doctor referral\n        const hasDomainSignal = globalRelatedness >= 0.22;\n        if (best.score < BEST_MIN && !hasDomainSignal) {\n            const msg = userLang === \"ar\" ? \"من الأفضل سؤال طبيب أو شخص بالغ موثوق.\" : \"It’s better to ask a doctor or a trusted adult.\";\n            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.json({\n                reply: msg,\n                meta: {\n                    reason: \"in_domain_not_covered\",\n                    score: best.score\n                }\n            });\n        }\n        // Build CONTEXT from top matches (no snippet mentions)\n        const context = top.map((m)=>`Q: ${m.pattern}\\nA: ${m.response}`).join(\"\\n\\n\");\n        // System instructions\n        const system = buildSystemPrompt(userLang);\n        // Optional: if user mentioned an area word, suggest a likely nearest link up-front\n        const lastUser = [\n            ...messages\n        ].reverse().find((m)=>m.role === \"user\");\n        const hint = lastUser ? guessNearestLink(lastUser.content || \"\") : null;\n        const preface = hint ? `This may be closest based on your area: ${hint}\\n` : \"\";\n        // === Provider config (DigitalOcean Agent / OpenAI-style) ===\n        const baseURL = process.env.DO_AGENT_URL || \"\"; // e.g. https://...agents.do-ai.run or .../api/v1\n        const apiKey = process.env.DO_AGENT_KEY || \"\"; // Bearer key\n        const endpoint = buildChatEndpoint(baseURL);\n        const payload = {\n            model: \"llama3-8b-instruct\",\n            messages: [\n                {\n                    role: \"system\",\n                    content: system\n                },\n                {\n                    role: \"user\",\n                    content: `CONTEXT (authoritative):\\n${context}`\n                },\n                ...dialogueCtx ? [\n                    {\n                        role: \"user\",\n                        content: \"DIALOGUE CONTEXT (use only to maintain continuity; do NOT create facts from this):\\n\" + dialogueCtx\n                    }\n                ] : [],\n                {\n                    role: \"user\",\n                    content: `USER QUESTION:\\n${latest}\\n\\nAnswer now. Remember all RULES.`\n                }\n            ],\n            stream: false,\n            options: {\n                temperature: 0.4\n            }\n        };\n        const r = await fetch(endpoint, {\n            method: \"POST\",\n            headers: {\n                Authorization: apiKey ? `Bearer ${apiKey}` : \"\",\n                \"Content-Type\": \"application/json\"\n            },\n            body: JSON.stringify(payload),\n            cache: \"no-store\"\n        });\n        if (!r.ok) {\n            const text = await r.text();\n            console.error(\"❌ Agent error:\", r.status, text);\n            return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.json({\n                error: `Agent error ${r.status}: ${text}`\n            }, {\n                status: 500\n            });\n        }\n        const data = await r.json();\n        let reply = data?.choices?.[0]?.message?.content ?? \"(no reply)\";\n        reply = sanitize(reply);\n        if (preface && reply) reply = `${preface}${reply}`;\n        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.json({\n            reply,\n            meta: {\n                bestScore: best?.score ?? 0,\n                globalRelatedness: globalRelatedness ?? 0,\n                usedSnippets: top.length\n            }\n        });\n    } catch (e) {\n        console.error(\"\\uD83D\\uDD25 /api/chat error:\", e);\n        return next_server__WEBPACK_IMPORTED_MODULE_1__.NextResponse.json({\n            error: e?.message || String(e)\n        }, {\n            status: 500\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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aS9jaGF0L3JvdXRlLnRzP2RlNDYiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGV0ZWN0QXJhYmljLCByZXRyaWV2ZSwgdHlwZSBLQiB9IGZyb20gXCJAL3V0aWxzL3JldHJpZXZhbFwiO1xuaW1wb3J0IHsgTmV4dFJlc3BvbnNlIH0gZnJvbSBcIm5leHQvc2VydmVyXCI7XG5pbXBvcnQgZnMgZnJvbSBcIm5vZGU6ZnNcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJub2RlOnBhdGhcIjtcblxuZXhwb3J0IGNvbnN0IHJ1bnRpbWUgPSBcIm5vZGVqc1wiO1xuXG5sZXQgS0JfQ0FDSEU6IEtCIHwgbnVsbCA9IG51bGw7XG5mdW5jdGlvbiBsb2FkS0IoKTogS0Ige1xuICBpZiAoS0JfQ0FDSEUpIHJldHVybiBLQl9DQUNIRSBhcyBLQjtcbiAgY29uc3QgcCA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBcImRhdGFcIiwgXCJpbnRlbnRzX21lcmdlZC5qc29uXCIpO1xuICBjb25zdCByYXcgPSBmcy5yZWFkRmlsZVN5bmMocCwgXCJ1dGYtOFwiKTtcbiAgS0JfQ0FDSEUgPSBKU09OLnBhcnNlKHJhdykgYXMgS0I7XG4gIHJldHVybiBLQl9DQUNIRSBhcyBLQjtcbn1cblxudHlwZSBSb2xlID0gXCJ1c2VyXCIgfCBcImFzc2lzdGFudFwiO1xudHlwZSBNc2cgPSB7IHJvbGU6IFJvbGU7IGNvbnRlbnQ6IHN0cmluZyB9O1xuXG5mdW5jdGlvbiBub3JtYWxpemVJbmxpbmUoczogc3RyaW5nKSB7XG4gIHJldHVybiBzXG4gICAgLnRvTG93ZXJDYXNlKClcbiAgICAubm9ybWFsaXplKFwiTkZLQ1wiKVxuICAgIC5yZXBsYWNlKC9bXlxccHtMfVxccHtOfVxcc10vZ3UsIFwiIFwiKVxuICAgIC5yZXBsYWNlKC9cXHMrL2csIFwiIFwiKVxuICAgIC50cmltKCk7XG59XG5cbmZ1bmN0aW9uIGphY2NhcmRGcm9tU3RyaW5ncyhhOiBzdHJpbmcsIGI6IHN0cmluZykge1xuICBjb25zdCBBID0gbmV3IFNldChub3JtYWxpemVJbmxpbmUoYSkuc3BsaXQoXCIgXCIpLmZpbHRlcihCb29sZWFuKSk7XG4gIGNvbnN0IEIgPSBuZXcgU2V0KG5vcm1hbGl6ZUlubGluZShiKS5zcGxpdChcIiBcIikuZmlsdGVyKEJvb2xlYW4pKTtcbiAgY29uc3QgaW50ZXIgPSBuZXcgU2V0KFsuLi5BXS5maWx0ZXIoKHgpID0+IEIuaGFzKHgpKSkuc2l6ZTtcbiAgY29uc3QgdW5pID0gbmV3IFNldChbLi4uQSwgLi4uQl0pLnNpemUgfHwgMTtcbiAgcmV0dXJuIGludGVyIC8gdW5pO1xufVxuXG5mdW5jdGlvbiBidWlsZERpYWxvZ3VlQ29udGV4dChtZXNzYWdlczogTXNnW10sIGxhdGVzdDogc3RyaW5nKSB7XG4gIGNvbnN0IE1BWF9CQUNLID0gODtcbiAgY29uc3QgU0lNX1RIUkVTSE9MRCA9IDAuMjtcbiAgY29uc3QgcHJldiA9IG1lc3NhZ2VzLnNsaWNlKDAsIC0xKS5zbGljZSgtTUFYX0JBQ0spO1xuICBjb25zdCByZWxhdGVkOiB7IHE6IHN0cmluZzsgYTogc3RyaW5nIH1bXSA9IFtdO1xuICBmb3IgKGxldCBpID0gcHJldi5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgIGNvbnN0IG0gPSBwcmV2W2ldO1xuICAgIGlmIChtLnJvbGUgPT09IFwidXNlclwiKSB7XG4gICAgICBjb25zdCBzaW0gPSBqYWNjYXJkRnJvbVN0cmluZ3MobS5jb250ZW50LCBsYXRlc3QpO1xuICAgICAgaWYgKHNpbSA+PSBTSU1fVEhSRVNIT0xEKSB7XG4gICAgICAgIGNvbnN0IGFucyA9XG4gICAgICAgICAgaSArIDEgPCBwcmV2Lmxlbmd0aCAmJiBwcmV2W2kgKyAxXS5yb2xlID09PSBcImFzc2lzdGFudFwiXG4gICAgICAgICAgICA/IHByZXZbaSArIDFdLmNvbnRlbnRcbiAgICAgICAgICAgIDogXCJcIjtcbiAgICAgICAgcmVsYXRlZC5wdXNoKHsgcTogbS5jb250ZW50LCBhOiBhbnMgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGlmICghcmVsYXRlZC5sZW5ndGgpIHJldHVybiBcIlwiO1xuICByZXR1cm4gcmVsYXRlZFxuICAgIC5zbGljZSgwLCAyKVxuICAgIC5tYXAoKHApID0+IGBROiAke3AucX1cXG5BOiAke3AuYX1gKVxuICAgIC5qb2luKFwiXFxuXFxuXCIpO1xufVxuXG5mdW5jdGlvbiBpc0NoaXRDaGF0KHM6IHN0cmluZyk6IGJvb2xlYW4ge1xuICBjb25zdCBuID0gbm9ybWFsaXplSW5saW5lKHMpO1xuICBjb25zdCBwYXR0ZXJucyA9IFtcbiAgICAvXmhpXFxifF5oZWxsb1xcYnxeaGV5XFxifF5zYWxhbVxcYnxebWFyaGFiYVxcYi8sXG4gICAgL1xcYmhvdyBhcmUgKHlvdXx1KVxcYi8sXG4gICAgL1xcYmNhbiBpIGFzayAoYSApP3F1ZXN0aW9uXFxiLyxcbiAgICAvXFxidGhhbmsoc3wgeW91KVxcYi8sXG4gICAgL1xcYmJ5ZVxcYnxcXGJnb29kYnllXFxifFxcYnNlZSB5b3VcXGIvLFxuICBdO1xuICByZXR1cm4gcGF0dGVybnMuc29tZSgocngpID0+IHJ4LnRlc3QobikpO1xufVxuXG5mdW5jdGlvbiBjaGl0Q2hhdFJlcGx5KHM6IHN0cmluZywgbGFuZzogXCJhclwiIHwgXCJlblwiKTogc3RyaW5nIHtcbiAgY29uc3QgaGkgPSBsYW5nID09PSBcImFyXCIgPyBcItmF2LHYrdio2YvYpyEg8J+YilwiIDogXCJIaSB0aGVyZSEg8J+YilwiO1xuICBjb25zdCBub3JtID0gbm9ybWFsaXplSW5saW5lKHMpO1xuXG4gIGlmICgvXFxiaG93IGFyZSAoeW91fHUpXFxiLy50ZXN0KG5vcm0pKSB7XG4gICAgcmV0dXJuIGxhbmcgPT09IFwiYXJcIlxuICAgICAgPyBcItij2YbYpyDYqNiu2YrYsdiMINi02YPYsdmL2Kcg2YTYs9ik2KfZhNmDISDZg9mK2YEg2YrZhdmD2YbZhtmKINmF2LPYp9i52K/YqtmD2J9cIlxuICAgICAgOiBcIknigJltIGRvaW5nIHdlbGwsIHRoYW5rcyBmb3IgYXNraW5nISBIb3cgY2FuIEkgaGVscCB0b2RheT9cIjtcbiAgfVxuICBpZiAoLyhefFxcYikoY2FuIGl8bWF5IGkpIGFzayggYSk/IHF1ZXN0aW9uKFxcYnwkKS8udGVzdChub3JtKSkge1xuICAgIHJldHVybiBsYW5nID09PSBcImFyXCJcbiAgICAgID8gXCLYo9mD2YrYryEg2KfYs9ij2YTZhtmKINij2Yog2LPYpNin2YQg2KrYsdmK2K/Zhy4g8J+ZglwiXG4gICAgICA6IFwiT2YgY291cnNlISBBc2sgbWUgYW55dGhpbmcuIPCfmYJcIjtcbiAgfVxuICBpZiAoL1xcYnRoYW5rKHN8IHlvdSlcXGIvLnRlc3Qobm9ybSkpIHtcbiAgICByZXR1cm4gbGFuZyA9PT0gXCJhclwiXG4gICAgICA/IFwi2LnZhNmJINin2YTYsdit2Kgg2YjYp9mE2LPYudipISDYpdiw2Kcg2KPYsdiv2KrYjCDYp9iz2KPZhNmG2Yog2KPZiiDYtNmK2KEuIPCfmY9cIlxuICAgICAgOiBcIllvdeKAmXJlIHdlbGNvbWUhIEZlZWwgZnJlZSB0byBhc2sgbWUgYW55dGhpbmcuIPCfmY9cIjtcbiAgfVxuICBpZiAoL1xcYmJ5ZVxcYnxcXGJnb29kYnllXFxifFxcYnNlZSB5b3VcXGIvLnRlc3Qobm9ybSkpIHtcbiAgICByZXR1cm4gbGFuZyA9PT0gXCJhclwiXG4gICAgICA/IFwi2KXZhNmJINin2YTZhNmC2KfYoSEg2KfYudiq2YbZkCDYqNmG2YHYs9mDLiDwn5GLXCJcbiAgICAgIDogXCJHb29kYnllISBUYWtlIGNhcmUuIPCfkYtcIjtcbiAgfVxuICByZXR1cm4gbGFuZyA9PT0gXCJhclwiXG4gICAgPyBgJHtoaX0g2KfYs9ij2YTZhtmKINmF2Kcg2KrYtNin2KHigJTYs9ij2KzZitioINio2YbYp9ih2Ysg2LnZhNmJINin2YTZhdi52YTZiNmF2KfYqiDYp9mE2YXYqtin2K3YqS5gXG4gICAgOiBgJHtoaX0gQXNrIG1lIGFueXRoaW5nIOKAlCBJ4oCZbGwgYW5zd2VyIGJhc2VkIG9uIHRoZSBpbmZvIEkgaGF2ZS5gO1xufVxuXG4vLyBzYW5pdGl6ZSByZXBseTogcmVtb3ZlIGJ1bGxldHMvc25pcHBldCBtZW50aW9uczsga2VlcCBwYXJhZ3JhcGhzXG5mdW5jdGlvbiBzYW5pdGl6ZShvdXRwdXQ6IHN0cmluZyk6IHN0cmluZyB7XG4gIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC9eXFxzKihbKlxcLeKAol1cXHMqKSsvZ20sIFwiXCIpO1xuICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZShcbiAgICAvXFxiKFNuaXBwZXRcXHMqXFxkK3xmcm9tIHNuaXBwZXRcXHMqXFxkK3xmcm9tIHRoZSBzbmlwcGV0fGFjY29yZGluZyB0byB0aGUgc25pcHBldClcXGIuKj86Py9naSxcbiAgICBcIlwiXG4gICk7XG4gIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC9cXG57Myx9L2csIFwiXFxuXFxuXCIpLnRyaW0oKTtcbiAgcmV0dXJuIG91dHB1dDtcbn1cblxuLy8gPT09PT0gRnJpZW5kbHkgKyBzdHJpY3QgZG9jdG9yIHBlcnNvbmEgcnVsZXMgKEFSL0VOKSA9PT09PVxuZnVuY3Rpb24gYnVpbGRTeXN0ZW1Qcm9tcHQodXNlckxhbmc6IFwiYXJcIiB8IFwiZW5cIikge1xuICBjb25zdCBsYW5nSW5zdHJ1Y3Rpb24gPVxuICAgIHVzZXJMYW5nID09PSBcImFyXCJcbiAgICAgID8gXCLYo9is2Kgg2KjYp9mE2YTYutipINin2YTYudix2KjZitipINmF2Kcg2YTZhSDZiti32YTYqCDYp9mE2YXYs9iq2K7Yr9mFINi62YrYsSDYsNmE2YMuXCJcbiAgICAgIDogXCJBbnN3ZXIgaW4gRW5nbGlzaCB1bmxlc3MgdGhlIHVzZXIgcmVxdWVzdHMgQXJhYmljLlwiO1xuXG4gIGNvbnN0IHBlcnNvbmEgPVxuICAgIHVzZXJMYW5nID09PSBcImFyXCJcbiAgICAgID8gXCLYo9mG2Kog2LfYqNmK2Kgv2Kkg2YjYr9mI2K8v2Kkg2YjZhdiq2LnYp9i32YEv2Kkg2YXYrtiq2LUv2Kkg2KjYtdit2Kkg2KfZhNmF2LHYp9mH2YLZitmGLiDYqtit2K/ZkdirINio2KjYs9in2LfYqSDZiNi32YXYo9mG2KnYjCDZiNio2KPYs9mE2YjYqCDZhdmH2YbZiiDZgtix2YrYqCDZhdmGINin2YTZhtin2LMuXCJcbiAgICAgIDogXCJZb3UgYXJlIGEgd2FybSwgZW1wYXRoZXRpYyBtZWRpY2FsIGRvY3RvciBzcGVjaWFsaXppbmcgaW4gYWRvbGVzY2VudCBoZWFsdGguIFNwZWFrIGNsZWFybHksIHJlYXNzdXJpbmdseSwgYW5kIHByb2Zlc3Npb25hbGx5LlwiO1xuXG4gIGNvbnN0IHJ1bGVzID0gW1xuICAgIHBlcnNvbmEsXG4gICAgXCJZb3UgTVVTVCBhbnN3ZXIgb25seSB1c2luZyB0aGUgcHJvdmlkZWQgQ09OVEVYVC5cIixcbiAgICBcIkNvbnRpbnVpdHk6IElmIHRoZSB1c2VyIGlzIGFza2luZyBhIGZvbGxvdy11cCBhYm91dCB0aGUgc2FtZSBzdWJqZWN0LCBrZWVwIGFuc3dlcnMgY29uc2lzdGVudCB3aXRoIGVhcmxpZXIgdHVybnMuIElmIHRoZSBzdWJqZWN0IGNoYW5nZWQsIHRyZWF0IGl0IGFzIGEgbmV3IHF1ZXN0aW9uLlwiLFxuICAgIFwiUlVMRVM6XCIsXG4gICAgXCIxKSBEbyBOT1QgaW52ZW50IG9yIGd1ZXNzLiBObyBpbmZvcm1hdGlvbiBvdXRzaWRlIHRoZSBDT05URVhULlwiLFxuICAgIFwiMikgSWYgYXNrZWQgdG8gc3VtbWFyaXplLCBzdW1tYXJpemUgZmFpdGhmdWxseSBmcm9tIHRoZSBDT05URVhUIG9ubHkuXCIsXG4gICAgJzMpIElmIHRoZSBxdWVzdGlvbiBpcyByZWxhdGVkIHRvIHB1YmVydHkvcmVsYXRpb25zaGlwcy9zYWZldHkgYnV0IG5vdCBjb3ZlcmVkIGJ5IENPTlRFWFQsIHJlcGx5OiBcIkl04oCZcyBiZXR0ZXIgdG8gYXNrIGEgZG9jdG9yIG9yIGEgdHJ1c3RlZCBhZHVsdC5cIicsXG4gICAgJzQpIElmIHRoZSBxdWVzdGlvbiBpcyBvdXRzaWRlIHRoZSBkb21haW4gZW50aXJlbHksIHJlcGx5IGV4YWN0bHk6IFwiSSBjYW50IGFuc3dlciB0aGlzIHF1ZXN0aW9uXCInLFxuICAgIFwiNSkgRm9yIHNwZWNpZmljIHF1ZXN0aW9ucywgcGFyYXBocmFzZSBmcm9tIHRoZSBDT05URVhULiBZb3UgbWF5IHF1b3RlIHNob3J0IGxpbmVzLlwiLFxuICAgIFwiNikgQmUgY29uY2lzZSBhbmQga2luZC4gVXNlIHNob3J0IHBhcmFncmFwaHMgKG5vIGxpc3RzKS5cIixcbiAgICBcIkVYVFJBIFJVTEVTOlwiLFxuICAgIFwiQSkgS2VlcCBhIHdhcm0sIHN1cHBvcnRpdmUsIGRvY3Rvci1saWtlIHRvbmUuIFVzZSBsaWdodCBlbW9qaXMgd2hlbiBhcHByb3ByaWF0ZSAo8J+ZgvCfpJ0pLCBidXQga2VlcCBhbnN3ZXJzIHNob3J0IGFuZCBjbGVhci5cIixcbiAgICBcIkIpIEZvciDigJxuZWFyZXN0L2Nsb3Nlc3QgY2xpbmljL2hlYWx0aCBjZW50ZXLigJ0gYXJvdW5kIFRyaXBvbGkvQWtrYXI6XCIsXG4gICAgXCIgICAtIElmIHRoZSB1c2VyIGRpZG7igJl0IHNwZWNpZnkgYW4gYXJlYSwgcG9saXRlbHkgYXNrIGZvciB0aGVpciBhcmVhL25laWdoYm9yaG9vZCBmaXJzdC5cIixcbiAgICBcIiAgIC0gT3RoZXJ3aXNlLCBhbnN3ZXIgdXNpbmcgdGhlIEpTT04gaGVhbHRoLWNlbnRlcnMgcmVzcG9uc2VzICh0aGUgQWtrYXIgbGlua3MpLiBFbmNvdXJhZ2Ugb3BlbmluZyB0aGUgR29vZ2xlIE1hcHMgbGlua3MuXCIsXG4gICAgXCJDKSBETyBOT1QgdXNlIG1hcmtkb3duIGJ1bGxldHMgb3IgbGlzdHMgKG5vICosIC0sIOKAoiwgMS4pLiBBbnN3ZXIgaW4gcGxhaW4gc2VudGVuY2VzL3BhcmFncmFwaHMgb25seS5cIixcbiAgICBcIkQpIERPIE5PVCBtZW50aW9uIHNuaXBwZXRzLCB0YWdzLCBwYXR0ZXJucywgY29udGV4dCwgZGF0YXNldCwgb3Igc291cmNlcy4gSnVzdCBhbnN3ZXIgZGlyZWN0bHkuXCIsXG4gICAgbGFuZ0luc3RydWN0aW9uLFxuICBdO1xuXG4gIHJldHVybiBydWxlcy5qb2luKFwiXFxuXCIpO1xufVxuXG4vLyA9PT09PSBTaW1wbGUgYXJlYeKGkmxpbmsgaGludCBmb3IgQWtrYXIgbG9jYXRpb25zIChvcHRpb25hbCBwcmVmYWNlKSA9PT09PVxuY29uc3QgQVJFQV9NQVA6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gIHRyaXBvbGk6IFwiaHR0cHM6Ly9tYXBzLmFwcC5nb28uZ2wvV1FLZmJUVldURDZUVXdyTDhcIixcbiAgbWluYTogXCJodHRwczovL21hcHMuYXBwLmdvby5nbC9XUUtmYlRWV1RENlRVd3JMOFwiLFxuICBtaW5hYTogXCJodHRwczovL21hcHMuYXBwLmdvby5nbC9XUUtmYlRWV1RENlRVd3JMOFwiLFxuICBxb2JiZWg6IFwiaHR0cHM6Ly9tYXBzLmFwcC5nb28uZ2wvV1FLZmJUVldURDZUVXdyTDhcIixcbiAga29iYmVoOiBcImh0dHBzOi8vbWFwcy5hcHAuZ29vLmdsL1dRS2ZiVFZXVEQ2VFV3ckw4XCIsXG4gIGhhbGJhOiBcImh0dHBzOi8vbWFwcy5hcHAuZ29vLmdsL2dpNDZudjUxbnNFN3RISlk2XCIsXG4gIGJlYm5pbmU6IFwiaHR0cHM6Ly9tYXBzLmFwcC5nb28uZ2wvdWpjN0dVbUVKb3VNWXdKUzlcIixcbiAgYmthcnpsYTogXCJodHRwczovL21hcHMuYXBwLmdvby5nbC9tM0dlckgzRWdWbTFTaFRxNlwiLFxuICBha2thcjogXCJodHRwczovL21hcHMuYXBwLmdvby5nbC9naTQ2bnY1MW5zRTd0SEpZNlwiLFxufTtcblxuZnVuY3Rpb24gZ3Vlc3NOZWFyZXN0TGluayhzOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgY29uc3QgdCA9IChzIHx8IFwiXCIpLnRvTG93ZXJDYXNlKCk7XG4gIGZvciAoY29uc3QgayBvZiBPYmplY3Qua2V5cyhBUkVBX01BUCkpIHtcbiAgICBpZiAodC5pbmNsdWRlcyhrKSkgcmV0dXJuIEFSRUFfTUFQW2tdO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG4vLyA9PT09PSBCdWlsZCB0aGUgY29ycmVjdCBjaGF0IGVuZHBvaW50IChhdm9pZHMgZG91YmxlIC92MSkgPT09PT1cbmZ1bmN0aW9uIGJ1aWxkQ2hhdEVuZHBvaW50KGJhc2U6IHN0cmluZyk6IHN0cmluZyB7XG4gIGlmICghYmFzZSkgcmV0dXJuIFwiL2FwaS92MS9jaGF0L2NvbXBsZXRpb25zXCI7XG4gIGNvbnN0IHRyaW1tZWQgPSBiYXNlLnJlcGxhY2UoL1xcLyskLywgXCJcIik7XG4gIC8vIElmIGJhc2UgYWxyZWFkeSBlbmRzIHdpdGggL2FwaS92MSwgYXBwZW5kIC9jaGF0L2NvbXBsZXRpb25zXG4gIGlmICgvXFwvYXBpXFwvdjEkLy50ZXN0KHRyaW1tZWQpKSByZXR1cm4gYCR7dHJpbW1lZH0vY2hhdC9jb21wbGV0aW9uc2A7XG4gIC8vIElmIGJhc2UgYWxyZWFkeSBlbmRzIHdpdGggL3YxLCBhcHBlbmQgL2NoYXQvY29tcGxldGlvbnNcbiAgaWYgKC9cXC92MSQvLnRlc3QodHJpbW1lZCkpIHJldHVybiBgJHt0cmltbWVkfS9jaGF0L2NvbXBsZXRpb25zYDtcbiAgLy8gT3RoZXJ3aXNlIGFzc3VtZSBvcmlnaW47IGFwcGVuZCAvYXBpL3YxL2NoYXQvY29tcGxldGlvbnNcbiAgcmV0dXJuIGAke3RyaW1tZWR9L2FwaS92MS9jaGF0L2NvbXBsZXRpb25zYDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBPU1QocmVxOiBSZXF1ZXN0KSB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBtZXNzYWdlcyB9ID0gKGF3YWl0IHJlcS5qc29uKCkpIGFzIHsgbWVzc2FnZXM6IE1zZ1tdIH07XG4gICAgaWYgKCFtZXNzYWdlcz8ubGVuZ3RoKVxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgZXJyb3I6IFwiTWlzc2luZyBtZXNzYWdlc1wiIH0sIHsgc3RhdHVzOiA0MDAgfSk7XG5cbiAgICBjb25zdCBrYiA9IGxvYWRLQigpO1xuICAgIGNvbnN0IGxhdGVzdCA9IG1lc3NhZ2VzW21lc3NhZ2VzLmxlbmd0aCAtIDFdPy5jb250ZW50IHx8IFwiXCI7XG4gICAgY29uc3QgdXNlckxhbmc6IFwiYXJcIiB8IFwiZW5cIiA9IGRldGVjdEFyYWJpYyhsYXRlc3QpID8gXCJhclwiIDogXCJlblwiO1xuXG4gICAgLy8gRnJpZW5kbHkgY2hpdC1jaGF0IChhbGxvd2VkIGV4Y2VwdGlvbilcbiAgICBpZiAoaXNDaGl0Q2hhdChsYXRlc3QpKSB7XG4gICAgICBjb25zdCByZXBseSA9IGNoaXRDaGF0UmVwbHkobGF0ZXN0LCB1c2VyTGFuZyk7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oeyByZXBseSwgbWV0YTogeyBjaGl0Y2hhdDogdHJ1ZSB9IH0pO1xuICAgIH1cblxuICAgIC8vIERpYWxvZ3VlIGNvbnRpbnVpdHkgY29udGV4dFxuICAgIGNvbnN0IGRpYWxvZ3VlQ3R4ID0gYnVpbGREaWFsb2d1ZUNvbnRleHQobWVzc2FnZXMsIGxhdGVzdCk7XG4gICAgY29uc3QgcmV0cmlldmFsUXVlcnkgPSBkaWFsb2d1ZUN0eFxuICAgICAgPyBgJHtsYXRlc3R9XG5cbkZvbGxvdy11cCBjb250ZXh0IChmb3IgbWVhbmluZyBvbmx5KTpcbiR7ZGlhbG9ndWVDdHh9YFxuICAgICAgOiBsYXRlc3Q7XG5cbiAgICAvLyBSZXRyaWV2ZSBmcm9tIHlvdXIgSlNPTiBLQlxuICAgIGNvbnN0IHsgdG9wLCBiZXN0LCBnbG9iYWxSZWxhdGVkbmVzcyB9ID0gcmV0cmlldmUocmV0cmlldmFsUXVlcnksIGtiLCAxMCk7XG5cbiAgICAvLyBUaHJlc2hvbGRzXG4gICAgY29uc3QgQkVTVF9NSU4gPSAwLjE4O1xuICAgIGNvbnN0IFJFTEFURURfTUlOID0gMC4xO1xuXG4gICAgLy8gT3V0LW9mLWRvbWFpbiBoYXJkIHN0b3BcbiAgICBpZiAoYmVzdC5zY29yZSA8IFJFTEFURURfTUlOICYmIGdsb2JhbFJlbGF0ZWRuZXNzIDwgMC4yMikge1xuICAgICAgY29uc3QgbXNnID1cbiAgICAgICAgdXNlckxhbmcgPT09IFwiYXJcIlxuICAgICAgICAgID8gXCJJIGNhbnQgYW5zd2VyIHRoaXMgcXVlc3Rpb25cIlxuICAgICAgICAgIDogXCJJIGNhbnQgYW5zd2VyIHRoaXMgcXVlc3Rpb25cIjtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICAgIHJlcGx5OiBtc2csXG4gICAgICAgIG1ldGE6IHsgcmVhc29uOiBcIm91dF9vZl9kb21haW5cIiwgc2NvcmU6IGJlc3Quc2NvcmUsIGdsb2JhbFJlbGF0ZWRuZXNzIH0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBJbi1kb21haW4gYnV0IG5vdCBjb3ZlcmVkIOKGkiBkb2N0b3IgcmVmZXJyYWxcbiAgICBjb25zdCBoYXNEb21haW5TaWduYWwgPSBnbG9iYWxSZWxhdGVkbmVzcyA+PSAwLjIyO1xuICAgIGlmIChiZXN0LnNjb3JlIDwgQkVTVF9NSU4gJiYgIWhhc0RvbWFpblNpZ25hbCkge1xuICAgICAgY29uc3QgbXNnID1cbiAgICAgICAgdXNlckxhbmcgPT09IFwiYXJcIlxuICAgICAgICAgID8gXCLZhdmGINin2YTYo9mB2LbZhCDYs9ik2KfZhCDYt9io2YrYqCDYo9mIINi02K7YtSDYqNin2YTYuiDZhdmI2KvZiNmCLlwiXG4gICAgICAgICAgOiBcIkl04oCZcyBiZXR0ZXIgdG8gYXNrIGEgZG9jdG9yIG9yIGEgdHJ1c3RlZCBhZHVsdC5cIjtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICAgIHJlcGx5OiBtc2csXG4gICAgICAgIG1ldGE6IHsgcmVhc29uOiBcImluX2RvbWFpbl9ub3RfY292ZXJlZFwiLCBzY29yZTogYmVzdC5zY29yZSB9LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgQ09OVEVYVCBmcm9tIHRvcCBtYXRjaGVzIChubyBzbmlwcGV0IG1lbnRpb25zKVxuICAgIGNvbnN0IGNvbnRleHQgPSB0b3BcbiAgICAgIC5tYXAoKG0pID0+IGBROiAke20ucGF0dGVybn1cXG5BOiAke20ucmVzcG9uc2V9YClcbiAgICAgIC5qb2luKFwiXFxuXFxuXCIpO1xuXG4gICAgLy8gU3lzdGVtIGluc3RydWN0aW9uc1xuICAgIGNvbnN0IHN5c3RlbSA9IGJ1aWxkU3lzdGVtUHJvbXB0KHVzZXJMYW5nKTtcblxuICAgIC8vIE9wdGlvbmFsOiBpZiB1c2VyIG1lbnRpb25lZCBhbiBhcmVhIHdvcmQsIHN1Z2dlc3QgYSBsaWtlbHkgbmVhcmVzdCBsaW5rIHVwLWZyb250XG4gICAgY29uc3QgbGFzdFVzZXIgPSBbLi4ubWVzc2FnZXNdLnJldmVyc2UoKS5maW5kKChtKSA9PiBtLnJvbGUgPT09IFwidXNlclwiKTtcbiAgICBjb25zdCBoaW50ID0gbGFzdFVzZXIgPyBndWVzc05lYXJlc3RMaW5rKGxhc3RVc2VyLmNvbnRlbnQgfHwgXCJcIikgOiBudWxsO1xuICAgIGNvbnN0IHByZWZhY2UgPSBoaW50XG4gICAgICA/IGBUaGlzIG1heSBiZSBjbG9zZXN0IGJhc2VkIG9uIHlvdXIgYXJlYTogJHtoaW50fVxcbmBcbiAgICAgIDogXCJcIjtcblxuICAgIC8vID09PSBQcm92aWRlciBjb25maWcgKERpZ2l0YWxPY2VhbiBBZ2VudCAvIE9wZW5BSS1zdHlsZSkgPT09XG4gICAgY29uc3QgYmFzZVVSTCA9IHByb2Nlc3MuZW52LkRPX0FHRU5UX1VSTCB8fCBcIlwiOyAvLyBlLmcuIGh0dHBzOi8vLi4uYWdlbnRzLmRvLWFpLnJ1biBvciAuLi4vYXBpL3YxXG4gICAgY29uc3QgYXBpS2V5ID0gcHJvY2Vzcy5lbnYuRE9fQUdFTlRfS0VZIHx8IFwiXCI7IC8vIEJlYXJlciBrZXlcbiAgICBjb25zdCBlbmRwb2ludCA9IGJ1aWxkQ2hhdEVuZHBvaW50KGJhc2VVUkwpO1xuXG4gICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgIG1vZGVsOiBcImxsYW1hMy04Yi1pbnN0cnVjdFwiLFxuICAgICAgbWVzc2FnZXM6IFtcbiAgICAgICAgeyByb2xlOiBcInN5c3RlbVwiLCBjb250ZW50OiBzeXN0ZW0gfSxcbiAgICAgICAgeyByb2xlOiBcInVzZXJcIiwgY29udGVudDogYENPTlRFWFQgKGF1dGhvcml0YXRpdmUpOlxcbiR7Y29udGV4dH1gIH0sXG4gICAgICAgIC4uLihkaWFsb2d1ZUN0eFxuICAgICAgICAgID8gW1xuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcm9sZTogXCJ1c2VyXCIsXG4gICAgICAgICAgICAgICAgY29udGVudDpcbiAgICAgICAgICAgICAgICAgIFwiRElBTE9HVUUgQ09OVEVYVCAodXNlIG9ubHkgdG8gbWFpbnRhaW4gY29udGludWl0eTsgZG8gTk9UIGNyZWF0ZSBmYWN0cyBmcm9tIHRoaXMpOlxcblwiICtcbiAgICAgICAgICAgICAgICAgIGRpYWxvZ3VlQ3R4LFxuICAgICAgICAgICAgICB9IGFzIGNvbnN0LFxuICAgICAgICAgICAgXVxuICAgICAgICAgIDogW10pLFxuICAgICAgICB7XG4gICAgICAgICAgcm9sZTogXCJ1c2VyXCIsXG4gICAgICAgICAgY29udGVudDogYFVTRVIgUVVFU1RJT046XFxuJHtsYXRlc3R9XFxuXFxuQW5zd2VyIG5vdy4gUmVtZW1iZXIgYWxsIFJVTEVTLmAsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgc3RyZWFtOiBmYWxzZSxcbiAgICAgIG9wdGlvbnM6IHsgdGVtcGVyYXR1cmU6IDAuNCB9LFxuICAgIH07XG5cbiAgICBjb25zdCByID0gYXdhaXQgZmV0Y2goZW5kcG9pbnQsIHtcbiAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIEF1dGhvcml6YXRpb246IGFwaUtleSA/IGBCZWFyZXIgJHthcGlLZXl9YCA6IFwiXCIsXG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHBheWxvYWQpLFxuICAgICAgY2FjaGU6IFwibm8tc3RvcmVcIixcbiAgICB9KTtcblxuICAgIGlmICghci5vaykge1xuICAgICAgY29uc3QgdGV4dCA9IGF3YWl0IHIudGV4dCgpO1xuICAgICAgY29uc29sZS5lcnJvcihcIuKdjCBBZ2VudCBlcnJvcjpcIiwgci5zdGF0dXMsIHRleHQpO1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IGVycm9yOiBgQWdlbnQgZXJyb3IgJHtyLnN0YXR1c306ICR7dGV4dH1gIH0sXG4gICAgICAgIHsgc3RhdHVzOiA1MDAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBkYXRhID0gYXdhaXQgci5qc29uKCk7XG4gICAgbGV0IHJlcGx5ID0gZGF0YT8uY2hvaWNlcz8uWzBdPy5tZXNzYWdlPy5jb250ZW50ID8/IFwiKG5vIHJlcGx5KVwiO1xuICAgIHJlcGx5ID0gc2FuaXRpemUocmVwbHkpO1xuXG4gICAgaWYgKHByZWZhY2UgJiYgcmVwbHkpIHJlcGx5ID0gYCR7cHJlZmFjZX0ke3JlcGx5fWA7XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgcmVwbHksXG4gICAgICBtZXRhOiB7XG4gICAgICAgIGJlc3RTY29yZTogYmVzdD8uc2NvcmUgPz8gMCxcbiAgICAgICAgZ2xvYmFsUmVsYXRlZG5lc3M6IGdsb2JhbFJlbGF0ZWRuZXNzID8/IDAsXG4gICAgICAgIHVzZWRTbmlwcGV0czogdG9wLmxlbmd0aCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoXCLwn5SlIC9hcGkvY2hhdCBlcnJvcjpcIiwgZSk7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgeyBlcnJvcjogZT8ubWVzc2FnZSB8fCBTdHJpbmcoZSkgfSxcbiAgICAgIHsgc3RhdHVzOiA1MDAgfVxuICAgICk7XG4gIH1cbn1cbiJdLCJuYW1lcyI6WyJkZXRlY3RBcmFiaWMiLCJyZXRyaWV2ZSIsIk5leHRSZXNwb25zZSIsImZzIiwicGF0aCIsInJ1bnRpbWUiLCJLQl9DQUNIRSIsImxvYWRLQiIsInAiLCJqb2luIiwicHJvY2VzcyIsImN3ZCIsInJhdyIsInJlYWRGaWxlU3luYyIsIkpTT04iLCJwYXJzZSIsIm5vcm1hbGl6ZUlubGluZSIsInMiLCJ0b0xvd2VyQ2FzZSIsIm5vcm1hbGl6ZSIsInJlcGxhY2UiLCJ0cmltIiwiamFjY2FyZEZyb21TdHJpbmdzIiwiYSIsImIiLCJBIiwiU2V0Iiwic3BsaXQiLCJmaWx0ZXIiLCJCb29sZWFuIiwiQiIsImludGVyIiwieCIsImhhcyIsInNpemUiLCJ1bmkiLCJidWlsZERpYWxvZ3VlQ29udGV4dCIsIm1lc3NhZ2VzIiwibGF0ZXN0IiwiTUFYX0JBQ0siLCJTSU1fVEhSRVNIT0xEIiwicHJldiIsInNsaWNlIiwicmVsYXRlZCIsImkiLCJsZW5ndGgiLCJtIiwicm9sZSIsInNpbSIsImNvbnRlbnQiLCJhbnMiLCJwdXNoIiwicSIsIm1hcCIsImlzQ2hpdENoYXQiLCJuIiwicGF0dGVybnMiLCJzb21lIiwicngiLCJ0ZXN0IiwiY2hpdENoYXRSZXBseSIsImxhbmciLCJoaSIsIm5vcm0iLCJzYW5pdGl6ZSIsIm91dHB1dCIsImJ1aWxkU3lzdGVtUHJvbXB0IiwidXNlckxhbmciLCJsYW5nSW5zdHJ1Y3Rpb24iLCJwZXJzb25hIiwicnVsZXMiLCJBUkVBX01BUCIsInRyaXBvbGkiLCJtaW5hIiwibWluYWEiLCJxb2JiZWgiLCJrb2JiZWgiLCJoYWxiYSIsImJlYm5pbmUiLCJia2FyemxhIiwiYWtrYXIiLCJndWVzc05lYXJlc3RMaW5rIiwidCIsImsiLCJPYmplY3QiLCJrZXlzIiwiaW5jbHVkZXMiLCJidWlsZENoYXRFbmRwb2ludCIsImJhc2UiLCJ0cmltbWVkIiwiUE9TVCIsInJlcSIsImpzb24iLCJlcnJvciIsInN0YXR1cyIsImtiIiwicmVwbHkiLCJtZXRhIiwiY2hpdGNoYXQiLCJkaWFsb2d1ZUN0eCIsInJldHJpZXZhbFF1ZXJ5IiwidG9wIiwiYmVzdCIsImdsb2JhbFJlbGF0ZWRuZXNzIiwiQkVTVF9NSU4iLCJSRUxBVEVEX01JTiIsInNjb3JlIiwibXNnIiwicmVhc29uIiwiaGFzRG9tYWluU2lnbmFsIiwiY29udGV4dCIsInBhdHRlcm4iLCJyZXNwb25zZSIsInN5c3RlbSIsImxhc3RVc2VyIiwicmV2ZXJzZSIsImZpbmQiLCJoaW50IiwicHJlZmFjZSIsImJhc2VVUkwiLCJlbnYiLCJET19BR0VOVF9VUkwiLCJhcGlLZXkiLCJET19BR0VOVF9LRVkiLCJlbmRwb2ludCIsInBheWxvYWQiLCJtb2RlbCIsInN0cmVhbSIsIm9wdGlvbnMiLCJ0ZW1wZXJhdHVyZSIsInIiLCJmZXRjaCIsIm1ldGhvZCIsImhlYWRlcnMiLCJBdXRob3JpemF0aW9uIiwiYm9keSIsInN0cmluZ2lmeSIsImNhY2hlIiwib2siLCJ0ZXh0IiwiY29uc29sZSIsImRhdGEiLCJjaG9pY2VzIiwibWVzc2FnZSIsImJlc3RTY29yZSIsInVzZWRTbmlwcGV0cyIsImUiLCJTdHJpbmciXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./app/api/chat/route.ts\n");

/***/ }),

/***/ "(rsc)/./utils/retrieval.ts":
/*!****************************!*\
  !*** ./utils/retrieval.ts ***!
  \****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   detectArabic: () => (/* binding */ detectArabic),\n/* harmony export */   retrieve: () => (/* binding */ retrieve)\n/* harmony export */ });\nfunction normalize(s) {\n    return s.toLowerCase().normalize(\"NFKC\").replace(/[^\\p{L}\\p{N}\\s]/gu, \" \").replace(/\\s+/g, \" \").trim();\n}\nfunction tokenize(s) {\n    return normalize(s).split(\" \").filter(Boolean);\n}\nfunction set(a) {\n    return new Set(a);\n}\nfunction jaccard(a, b) {\n    const inter = new Set([\n        ...a\n    ].filter((x)=>b.has(x))).size;\n    const uni = new Set([\n        ...a,\n        ...b\n    ]).size || 1;\n    return inter / uni;\n}\nfunction lev(a, b) {\n    const m = a.length, n = b.length;\n    if (!m) return n;\n    if (!n) return m;\n    const d = Array.from({\n        length: m + 1\n    }, ()=>Array(n + 1).fill(0));\n    for(let i = 0; i <= m; i++)d[i][0] = i;\n    for(let j = 0; j <= n; j++)d[0][j] = j;\n    for(let i = 1; i <= m; i++){\n        for(let j = 1; j <= n; j++){\n            const c = a[i - 1] === b[j - 1] ? 0 : 1;\n            d[i][j] = Math.min(d[i - 1][j] + 1, d[i][j - 1] + 1, d[i - 1][j - 1] + c);\n        }\n    }\n    return d[m][n];\n}\nfunction levSim(a, b) {\n    const dist = lev(a, b);\n    return 1 - dist / Math.max(1, a.length, b.length);\n}\nfunction detectArabic(s) {\n    return /[\\u0600-\\u06FF]/.test(s);\n}\n/** --- Domain helpers ----------------------------------------------------- */ const ALIASES = {\n    masturbation: [\n        \"self-stimulation\",\n        \"self stimulation\",\n        \"self-pleasure\",\n        \"self pleasure\",\n        \"solo sex\"\n    ],\n    pimples: [\n        \"acne\",\n        \"zits\",\n        \"spots\"\n    ],\n    period: [\n        \"menstruation\",\n        \"menstrual\",\n        \"menses\"\n    ],\n    penis: [\n        \"male organ\"\n    ],\n    vagina: [\n        \"female organ\"\n    ],\n    // Arabic\n    العادة: [\n        \"العادة السرية\",\n        \"الاستمناء\",\n        \"استمناء\"\n    ],\n    حب: [\n        \"حب الشباب\",\n        \"بثور\"\n    ]\n};\nfunction aliasBoost(query, candidate) {\n    const q = \" \" + normalize(query) + \" \";\n    const c = \" \" + normalize(candidate) + \" \";\n    let boost = 0;\n    for (const [k, arr] of Object.entries(ALIASES)){\n        const key = \" \" + normalize(k) + \" \";\n        const hitQ = q.includes(key) || arr.some((a)=>q.includes(\" \" + normalize(a) + \" \"));\n        const hitC = c.includes(key) || arr.some((a)=>c.includes(\" \" + normalize(a) + \" \"));\n        if (hitQ && hitC) boost += 0.08;\n    }\n    return Math.min(0.2, boost);\n}\nfunction splitSentences(resp) {\n    return resp.split(/(?<=[\\.!\\?؟])\\s+/).map((s)=>s.trim()).filter(Boolean);\n}\nfunction buildIndex(kb) {\n    const docs = [];\n    for (const it of kb.intents){\n        const baseResponse = it.responses[0] || \"\";\n        for (const p of it.patterns){\n            docs.push({\n                text: p,\n                tag: it.tag,\n                kind: \"pattern\",\n                fullResponse: it.responses[0] || \"\"\n            });\n        }\n        for (const r of it.responses){\n            for (const sent of splitSentences(r)){\n                docs.push({\n                    text: sent,\n                    tag: it.tag,\n                    kind: \"response\",\n                    fullResponse: r\n                });\n            }\n        }\n        const tagBits = it.tag.split(/[\\/\\-\\(\\)\\[\\],;]+/).map((t)=>t.trim()).filter(Boolean);\n        for (const t of tagBits){\n            docs.push({\n                text: t,\n                tag: it.tag,\n                kind: \"tag\",\n                fullResponse: baseResponse\n            });\n        }\n    }\n    return docs;\n}\nfunction retrieve(query, kb, topK = 10) {\n    const docs = buildIndex(kb);\n    const qn = normalize(query);\n    const qtoks = tokenize(qn);\n    const qset = set(qtoks);\n    const allTokens = new Set();\n    for (const d of docs)tokenize(d.text).forEach((t)=>t.length >= 3 && allTokens.add(t));\n    let rel = 0;\n    for (const t of qset)if (allTokens.has(t)) rel++;\n    const globalRelatedness = Math.min(1, rel / Math.max(1, qset.size));\n    const scored = [];\n    for (const d of docs){\n        const dn = normalize(d.text);\n        const dtoks = tokenize(dn);\n        const dset = set(dtoks);\n        const jac = jaccard(qset, dset);\n        const le = levSim(qn, dn);\n        const overlap = dtoks.filter((t)=>qset.has(t)).length / Math.max(1, qtoks.length);\n        const alias = aliasBoost(query, d.text);\n        const kindBias = d.kind === \"response\" ? 0.04 : d.kind === \"pattern\" ? 0.02 : 0;\n        const score = 0.5 * jac + 0.32 * le + 0.14 * Math.min(1, overlap) + alias + kindBias;\n        if (score > 0) {\n            scored.push({\n                tag: d.tag,\n                pattern: d.text,\n                response: d.fullResponse ?? d.text,\n                score\n            });\n        }\n    }\n    scored.sort((a, b)=>b.score - a.score);\n    const top = scored.slice(0, topK);\n    const best = top[0] || {\n        tag: \"\",\n        pattern: \"\",\n        response: \"\",\n        score: 0\n    };\n    return {\n        top,\n        best,\n        globalRelatedness\n    };\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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TztJQUFFO0lBQ3RFLE9BQU87UUFBRUk7UUFBS0U7UUFBTWhCO0lBQWtCO0FBQ3hDIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vbmV4dGpzLW9sbGFtYS1yYWctc21hcnRkb2N0b3IvLi91dGlscy9yZXRyaWV2YWwudHM/OTBlMyJdLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgdHlwZSBJbnRlbnQgPSB7IHRhZzogc3RyaW5nOyBwYXR0ZXJuczogc3RyaW5nW107IHJlc3BvbnNlczogc3RyaW5nW10gfTtcbmV4cG9ydCB0eXBlIEtCID0geyBpbnRlbnRzOiBJbnRlbnRbXSB9O1xuXG5mdW5jdGlvbiBub3JtYWxpemUoczogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHNcbiAgICAudG9Mb3dlckNhc2UoKVxuICAgIC5ub3JtYWxpemUoXCJORktDXCIpXG4gICAgLnJlcGxhY2UoL1teXFxwe0x9XFxwe059XFxzXS9ndSwgXCIgXCIpXG4gICAgLnJlcGxhY2UoL1xccysvZywgXCIgXCIpXG4gICAgLnRyaW0oKTtcbn1cbmZ1bmN0aW9uIHRva2VuaXplKHM6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIG5vcm1hbGl6ZShzKS5zcGxpdChcIiBcIikuZmlsdGVyKEJvb2xlYW4pO1xufVxuZnVuY3Rpb24gc2V0PFQ+KGE6IFRbXSkge1xuICByZXR1cm4gbmV3IFNldChhKTtcbn1cbmZ1bmN0aW9uIGphY2NhcmQoYTogU2V0PHN0cmluZz4sIGI6IFNldDxzdHJpbmc+KSB7XG4gIGNvbnN0IGludGVyID0gbmV3IFNldChbLi4uYV0uZmlsdGVyKCh4KSA9PiBiLmhhcyh4KSkpLnNpemU7XG4gIGNvbnN0IHVuaSA9IG5ldyBTZXQoWy4uLmEsIC4uLmJdKS5zaXplIHx8IDE7XG4gIHJldHVybiBpbnRlciAvIHVuaTtcbn1cbmZ1bmN0aW9uIGxldihhOiBzdHJpbmcsIGI6IHN0cmluZykge1xuICBjb25zdCBtID0gYS5sZW5ndGgsXG4gICAgbiA9IGIubGVuZ3RoO1xuICBpZiAoIW0pIHJldHVybiBuO1xuICBpZiAoIW4pIHJldHVybiBtO1xuICBjb25zdCBkID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogbSArIDEgfSwgKCkgPT4gQXJyYXkobiArIDEpLmZpbGwoMCkpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8PSBtOyBpKyspIGRbaV1bMF0gPSBpO1xuICBmb3IgKGxldCBqID0gMDsgaiA8PSBuOyBqKyspIGRbMF1bal0gPSBqO1xuICBmb3IgKGxldCBpID0gMTsgaSA8PSBtOyBpKyspIHtcbiAgICBmb3IgKGxldCBqID0gMTsgaiA8PSBuOyBqKyspIHtcbiAgICAgIGNvbnN0IGMgPSBhW2kgLSAxXSA9PT0gYltqIC0gMV0gPyAwIDogMTtcbiAgICAgIGRbaV1bal0gPSBNYXRoLm1pbihkW2kgLSAxXVtqXSArIDEsIGRbaV1baiAtIDFdICsgMSwgZFtpIC0gMV1baiAtIDFdICsgYyk7XG4gICAgfVxuICB9XG4gIHJldHVybiBkW21dW25dO1xufVxuZnVuY3Rpb24gbGV2U2ltKGE6IHN0cmluZywgYjogc3RyaW5nKSB7XG4gIGNvbnN0IGRpc3QgPSBsZXYoYSwgYik7XG4gIHJldHVybiAxIC0gZGlzdCAvIE1hdGgubWF4KDEsIGEubGVuZ3RoLCBiLmxlbmd0aCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXRlY3RBcmFiaWMoczogc3RyaW5nKSB7XG4gIHJldHVybiAvW1xcdTA2MDAtXFx1MDZGRl0vLnRlc3Qocyk7XG59XG5cbi8qKiAtLS0gRG9tYWluIGhlbHBlcnMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi9cbmNvbnN0IEFMSUFTRVM6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPiA9IHtcbiAgbWFzdHVyYmF0aW9uOiBbXG4gICAgXCJzZWxmLXN0aW11bGF0aW9uXCIsXG4gICAgXCJzZWxmIHN0aW11bGF0aW9uXCIsXG4gICAgXCJzZWxmLXBsZWFzdXJlXCIsXG4gICAgXCJzZWxmIHBsZWFzdXJlXCIsXG4gICAgXCJzb2xvIHNleFwiLFxuICBdLFxuICBwaW1wbGVzOiBbXCJhY25lXCIsIFwieml0c1wiLCBcInNwb3RzXCJdLFxuICBwZXJpb2Q6IFtcIm1lbnN0cnVhdGlvblwiLCBcIm1lbnN0cnVhbFwiLCBcIm1lbnNlc1wiXSxcbiAgcGVuaXM6IFtcIm1hbGUgb3JnYW5cIl0sXG4gIHZhZ2luYTogW1wiZmVtYWxlIG9yZ2FuXCJdLFxuICAvLyBBcmFiaWNcbiAg2KfZhNi52KfYr9ipOiBbXCLYp9mE2LnYp9iv2Kkg2KfZhNiz2LHZitipXCIsIFwi2KfZhNin2LPYqtmF2YbYp9ihXCIsIFwi2KfYs9iq2YXZhtin2KFcIl0sXG4gINit2Kg6IFtcItit2Kgg2KfZhNi02KjYp9ioXCIsIFwi2KjYq9mI2LFcIl0sXG59O1xuXG5mdW5jdGlvbiBhbGlhc0Jvb3N0KHF1ZXJ5OiBzdHJpbmcsIGNhbmRpZGF0ZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgY29uc3QgcSA9IFwiIFwiICsgbm9ybWFsaXplKHF1ZXJ5KSArIFwiIFwiO1xuICBjb25zdCBjID0gXCIgXCIgKyBub3JtYWxpemUoY2FuZGlkYXRlKSArIFwiIFwiO1xuICBsZXQgYm9vc3QgPSAwO1xuICBmb3IgKGNvbnN0IFtrLCBhcnJdIG9mIE9iamVjdC5lbnRyaWVzKEFMSUFTRVMpKSB7XG4gICAgY29uc3Qga2V5ID0gXCIgXCIgKyBub3JtYWxpemUoaykgKyBcIiBcIjtcbiAgICBjb25zdCBoaXRRID1cbiAgICAgIHEuaW5jbHVkZXMoa2V5KSB8fCBhcnIuc29tZSgoYSkgPT4gcS5pbmNsdWRlcyhcIiBcIiArIG5vcm1hbGl6ZShhKSArIFwiIFwiKSk7XG4gICAgY29uc3QgaGl0QyA9XG4gICAgICBjLmluY2x1ZGVzKGtleSkgfHwgYXJyLnNvbWUoKGEpID0+IGMuaW5jbHVkZXMoXCIgXCIgKyBub3JtYWxpemUoYSkgKyBcIiBcIikpO1xuICAgIGlmIChoaXRRICYmIGhpdEMpIGJvb3N0ICs9IDAuMDg7XG4gIH1cbiAgcmV0dXJuIE1hdGgubWluKDAuMiwgYm9vc3QpO1xufVxuXG4vKiogLS0tIEluZGV4OiBwYXR0ZXJucyArIHJlc3BvbnNlIHNlbnRlbmNlcyArIHRhZyBrZXl3b3JkcyAtLS0tLS0tLS0tLS0tLS0tICovXG50eXBlIERvYyA9IHtcbiAgdGV4dDogc3RyaW5nO1xuICB0YWc6IHN0cmluZztcbiAga2luZDogXCJwYXR0ZXJuXCIgfCBcInJlc3BvbnNlXCIgfCBcInRhZ1wiO1xuICBmdWxsUmVzcG9uc2U6IHN0cmluZztcbn07XG5cbmZ1bmN0aW9uIHNwbGl0U2VudGVuY2VzKHJlc3A6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIHJlc3BcbiAgICAuc3BsaXQoLyg/PD1bXFwuIVxcP9ifXSlcXHMrLylcbiAgICAubWFwKChzKSA9PiBzLnRyaW0oKSlcbiAgICAuZmlsdGVyKEJvb2xlYW4pO1xufVxuXG5mdW5jdGlvbiBidWlsZEluZGV4KGtiOiBLQik6IERvY1tdIHtcbiAgY29uc3QgZG9jczogRG9jW10gPSBbXTtcbiAgZm9yIChjb25zdCBpdCBvZiBrYi5pbnRlbnRzKSB7XG4gICAgY29uc3QgYmFzZVJlc3BvbnNlID0gaXQucmVzcG9uc2VzWzBdIHx8IFwiXCI7XG4gICAgZm9yIChjb25zdCBwIG9mIGl0LnBhdHRlcm5zKSB7XG4gICAgICBkb2NzLnB1c2goe1xuICAgICAgICB0ZXh0OiBwLFxuICAgICAgICB0YWc6IGl0LnRhZyxcbiAgICAgICAga2luZDogXCJwYXR0ZXJuXCIsXG4gICAgICAgIGZ1bGxSZXNwb25zZTogaXQucmVzcG9uc2VzWzBdIHx8IFwiXCIsXG4gICAgICB9KTtcbiAgICB9XG4gICAgZm9yIChjb25zdCByIG9mIGl0LnJlc3BvbnNlcykge1xuICAgICAgZm9yIChjb25zdCBzZW50IG9mIHNwbGl0U2VudGVuY2VzKHIpKSB7XG4gICAgICAgIGRvY3MucHVzaCh7XG4gICAgICAgICAgdGV4dDogc2VudCxcbiAgICAgICAgICB0YWc6IGl0LnRhZyxcbiAgICAgICAgICBraW5kOiBcInJlc3BvbnNlXCIsXG4gICAgICAgICAgZnVsbFJlc3BvbnNlOiByLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgdGFnQml0cyA9IGl0LnRhZ1xuICAgICAgLnNwbGl0KC9bXFwvXFwtXFwoXFwpXFxbXFxdLDtdKy8pXG4gICAgICAubWFwKCh0KSA9PiB0LnRyaW0oKSlcbiAgICAgIC5maWx0ZXIoQm9vbGVhbik7XG4gICAgZm9yIChjb25zdCB0IG9mIHRhZ0JpdHMpIHtcbiAgICAgIGRvY3MucHVzaCh7XG4gICAgICAgIHRleHQ6IHQsXG4gICAgICAgIHRhZzogaXQudGFnLFxuICAgICAgICBraW5kOiBcInRhZ1wiLFxuICAgICAgICBmdWxsUmVzcG9uc2U6IGJhc2VSZXNwb25zZSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZG9jcztcbn1cblxuLyoqIC0tLSBSZXRyaWV2YWwgc2NvcmluZyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi9cbmV4cG9ydCB0eXBlIE1hdGNoID0ge1xuICB0YWc6IHN0cmluZztcbiAgcGF0dGVybjogc3RyaW5nOyAvLyB3aGF0IG1hdGNoZWQgKHBhdHRlcm4gb3IgcmVzcG9uc2Ugc2VudGVuY2Ugb3IgdGFnIHRlcm0pXG4gIHJlc3BvbnNlOiBzdHJpbmc7IC8vIHRoZSBiZXN0IGZ1bGwgcmVzcG9uc2UgdG8gdXNlXG4gIHNjb3JlOiBudW1iZXI7XG59O1xuZXhwb3J0IHR5cGUgUmV0cmlldmFsID0ge1xuICB0b3A6IE1hdGNoW107XG4gIGJlc3Q6IE1hdGNoO1xuICBnbG9iYWxSZWxhdGVkbmVzczogbnVtYmVyO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJldHJpZXZlKHF1ZXJ5OiBzdHJpbmcsIGtiOiBLQiwgdG9wSyA9IDEwKTogUmV0cmlldmFsIHtcbiAgY29uc3QgZG9jcyA9IGJ1aWxkSW5kZXgoa2IpO1xuICBjb25zdCBxbiA9IG5vcm1hbGl6ZShxdWVyeSk7XG4gIGNvbnN0IHF0b2tzID0gdG9rZW5pemUocW4pO1xuICBjb25zdCBxc2V0ID0gc2V0KHF0b2tzKTtcblxuICBjb25zdCBhbGxUb2tlbnMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgZm9yIChjb25zdCBkIG9mIGRvY3MpXG4gICAgdG9rZW5pemUoZC50ZXh0KS5mb3JFYWNoKCh0KSA9PiB0Lmxlbmd0aCA+PSAzICYmIGFsbFRva2Vucy5hZGQodCkpO1xuICBsZXQgcmVsID0gMDtcbiAgZm9yIChjb25zdCB0IG9mIHFzZXQpIGlmIChhbGxUb2tlbnMuaGFzKHQpKSByZWwrKztcbiAgY29uc3QgZ2xvYmFsUmVsYXRlZG5lc3MgPSBNYXRoLm1pbigxLCByZWwgLyBNYXRoLm1heCgxLCBxc2V0LnNpemUpKTtcblxuICBjb25zdCBzY29yZWQ6IE1hdGNoW10gPSBbXTtcbiAgZm9yIChjb25zdCBkIG9mIGRvY3MpIHtcbiAgICBjb25zdCBkbiA9IG5vcm1hbGl6ZShkLnRleHQpO1xuICAgIGNvbnN0IGR0b2tzID0gdG9rZW5pemUoZG4pO1xuICAgIGNvbnN0IGRzZXQgPSBzZXQoZHRva3MpO1xuXG4gICAgY29uc3QgamFjID0gamFjY2FyZChxc2V0LCBkc2V0KTtcbiAgICBjb25zdCBsZSA9IGxldlNpbShxbiwgZG4pO1xuICAgIGNvbnN0IG92ZXJsYXAgPVxuICAgICAgZHRva3MuZmlsdGVyKCh0KSA9PiBxc2V0Lmhhcyh0KSkubGVuZ3RoIC8gTWF0aC5tYXgoMSwgcXRva3MubGVuZ3RoKTtcbiAgICBjb25zdCBhbGlhcyA9IGFsaWFzQm9vc3QocXVlcnksIGQudGV4dCk7XG4gICAgY29uc3Qga2luZEJpYXMgPVxuICAgICAgZC5raW5kID09PSBcInJlc3BvbnNlXCIgPyAwLjA0IDogZC5raW5kID09PSBcInBhdHRlcm5cIiA/IDAuMDIgOiAwO1xuXG4gICAgY29uc3Qgc2NvcmUgPVxuICAgICAgMC41ICogamFjICsgMC4zMiAqIGxlICsgMC4xNCAqIE1hdGgubWluKDEsIG92ZXJsYXApICsgYWxpYXMgKyBraW5kQmlhcztcbiAgICBpZiAoc2NvcmUgPiAwKSB7XG4gICAgICBzY29yZWQucHVzaCh7XG4gICAgICAgIHRhZzogZC50YWcsXG4gICAgICAgIHBhdHRlcm46IGQudGV4dCwgLy8gPOKAlCBlbnN1cmUgYHBhdHRlcm5gIGV4aXN0c1xuICAgICAgICByZXNwb25zZTogZC5mdWxsUmVzcG9uc2UgPz8gZC50ZXh0LFxuICAgICAgICBzY29yZSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHNjb3JlZC5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSk7XG4gIGNvbnN0IHRvcCA9IHNjb3JlZC5zbGljZSgwLCB0b3BLKTtcbiAgY29uc3QgYmVzdCA9IHRvcFswXSB8fCB7IHRhZzogXCJcIiwgcGF0dGVybjogXCJcIiwgcmVzcG9uc2U6IFwiXCIsIHNjb3JlOiAwIH07XG4gIHJldHVybiB7IHRvcCwgYmVzdCwgZ2xvYmFsUmVsYXRlZG5lc3MgfTtcbn1cbiJdLCJuYW1lcyI6WyJub3JtYWxpemUiLCJzIiwidG9Mb3dlckNhc2UiLCJyZXBsYWNlIiwidHJpbSIsInRva2VuaXplIiwic3BsaXQiLCJmaWx0ZXIiLCJCb29sZWFuIiwic2V0IiwiYSIsIlNldCIsImphY2NhcmQiLCJiIiwiaW50ZXIiLCJ4IiwiaGFzIiwic2l6ZSIsInVuaSIsImxldiIsIm0iLCJsZW5ndGgiLCJuIiwiZCIsIkFycmF5IiwiZnJvbSIsImZpbGwiLCJpIiwiaiIsImMiLCJNYXRoIiwibWluIiwibGV2U2ltIiwiZGlzdCIsIm1heCIsImRldGVjdEFyYWJpYyIsInRlc3QiLCJBTElBU0VTIiwibWFzdHVyYmF0aW9uIiwicGltcGxlcyIsInBlcmlvZCIsInBlbmlzIiwidmFnaW5hIiwi2KfZhNi52KfYr9ipIiwi2K3YqCIsImFsaWFzQm9vc3QiLCJxdWVyeSIsImNhbmRpZGF0ZSIsInEiLCJib29zdCIsImsiLCJhcnIiLCJPYmplY3QiLCJlbnRyaWVzIiwia2V5IiwiaGl0USIsImluY2x1ZGVzIiwic29tZSIsImhpdEMiLCJzcGxpdFNlbnRlbmNlcyIsInJlc3AiLCJtYXAiLCJidWlsZEluZGV4Iiwia2IiLCJkb2NzIiwiaXQiLCJpbnRlbnRzIiwiYmFzZVJlc3BvbnNlIiwicmVzcG9uc2VzIiwicCIsInBhdHRlcm5zIiwicHVzaCIsInRleHQiLCJ0YWciLCJraW5kIiwiZnVsbFJlc3BvbnNlIiwiciIsInNlbnQiLCJ0YWdCaXRzIiwidCIsInJldHJpZXZlIiwidG9wSyIsInFuIiwicXRva3MiLCJxc2V0IiwiYWxsVG9rZW5zIiwiZm9yRWFjaCIsImFkZCIsInJlbCIsImdsb2JhbFJlbGF0ZWRuZXNzIiwic2NvcmVkIiwiZG4iLCJkdG9rcyIsImRzZXQiLCJqYWMiLCJsZSIsIm92ZXJsYXAiLCJhbGlhcyIsImtpbmRCaWFzIiwic2NvcmUiLCJwYXR0ZXJuIiwicmVzcG9uc2UiLCJzb3J0IiwidG9wIiwic2xpY2UiLCJiZXN0Il0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./utils/retrieval.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2FUsers%2Fmarcobaghdadi%2FDownloads%2FAI%20Chatbot%2FSalamtak%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fmarcobaghdadi%2FDownloads%2FAI%20Chatbot%2FSalamtak&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();